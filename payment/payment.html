<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Payment Page</title>
  <link rel="stylesheet" href="payment.css">
</head>
<body>
  <div class="container">
    <h2>Registration Form</h2>
    <form id="paymentForm">
      <label for="name">Name</label>
      <input type="text" id="name" required placeholder="Enter your name" />

      <label for="year">Year</label>
      <select id="year" required>
        <option value="">Select Year</option>
        <option value="1st Year">1st Year</option>
        <option value="2nd Year">2nd Year</option>
        <option value="3rd Year">3rd Year</option>
        <option value="4th Year">4th Year</option>
      </select>

      <label for="branch">Branch</label>
      <select id="branch" required>
        <option value="">Select Branch</option>
        <option value="CSE">CSE</option>
        <option value="Civil">Civil</option>
        <option value="Mech">Mech</option>
        <option value="Automobile">Automobile</option>
      </select>

      <label for="eventType">Event Type</label>
      <select id="eventType" required>
        <option value="">Select Event Type</option>
        <option value="Sports">Sports</option>
        <option value="Arts">Arts</option>
        <option value="Tech">Tech</option>
      </select>

      <label for="transactionId">Transaction ID</label>
      <input type="text" id="transactionId" pattern="^[A-Za-z0-9]{12}$" required placeholder="Enter Transaction ID (12 chars)" />

      <label for="uploadImage">Upload Image</label>
      <input type="file" id="uploadImage" required />

      <button type="submit" id="submitBtn">Submit</button>
    </form>
  </div>

  <h3>Payment Records:</h3>
  <ul id="paymentsList"></ul>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    // Initialize Supabase
    const supabaseUrl = 'https://ihrjhhxfyhphsfzedaeg.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlocmpoaHhmeWhwaHNmemVkYWVnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzgzMjMxNTgsImV4cCI6MjA1Mzg5OTE1OH0.XtfosCxO1Cg8ytpNNMXnYCYDkaiomXcon3Z5bAlZwcY';
    const supabase = createClient(supabaseUrl, supabaseKey);

    const form = document.getElementById("paymentForm");
    const paymentsList = document.getElementById("paymentsList");

    form.addEventListener('submit', async function (e) {
      e.preventDefault();

      const name = document.getElementById("name").value;
      const year = document.getElementById("year").value;
      const branch = document.getElementById("branch").value;
      const eventType = document.getElementById("eventType").value;
      const transactionId = document.getElementById("transactionId").value;
      const imageFile = document.getElementById("uploadImage").files[0];

      // Upload the image to Supabase Storage
      const { data: storageData, error: storageError } = await supabase.storage
        .from('event-images')
        .upload(`images/${Date.now()}_${imageFile.name}`, imageFile);

      if (storageError) {
        console.error('Error uploading image:', storageError.message);
        return;
      }

      // Get the public URL of the uploaded image
      const imageUrl = supabase.storage.from('event-images').getPublicUrl(storageData.path).publicURL;
      console.log('Image URL:', imageUrl);  // Log the image URL to ensure it's correct

      // Insert data into the 'registrations' table
      const { data, error } = await supabase
        .from('registrations')
        .insert([
          { 
            name, 
            year, 
            branch, 
            eventType, 
            transactionId, 
            imageUrl 
          }
        ]);

      if (error) {
        console.error('Error inserting registration:', error.message);
        alert('Registration failed!');
      } else {
        alert('Registration submitted successfully!');
        form.reset();
        fetchPayments();  // Refresh the payments list after successful submission
      }
    });

    // Fetch and display the payments list
    async function fetchPayments() {
      const { data, error } = await supabase.from('registrations').select('*');

      if (error) {
        console.error('Error fetching payments:', error.message);
      } else {
        console.log('Fetched data:', data);  // Log the fetched data to see what's returned
        paymentsList.innerHTML = '';  // Clear existing list

        // Loop through the fetched data and create list items
        data.forEach(payment => {
          const listItem = document.createElement('li');
          listItem.innerHTML = `
            ${payment.name} (${payment.year}, ${payment.branch}) registered for ${payment.eventType} on ${payment.timestamp}
            <br><img src="${payment.imageUrl}" alt="Image" width="100">
          `;
          paymentsList.appendChild(listItem);
        });
      }
    }

    // Call the fetchPayments function on page load to display the records
    window.onload = fetchPayments;

  </script>
</body>
</html>
